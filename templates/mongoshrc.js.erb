function rsReconfigMember(member){
  var cfg = rs.config()
  cfg.members.forEach(function(part,index,memberArray){
    if (member.host == part.host) {
      for(k in member){
        memberArray[index][k] = member[k]
      }
    }
  })
  return rs.reconfig(cfg)
}

function rsReconfigSettings(settings){
  var cfg = rs.config()
  cfg.settings = settings
  return rs.reconfig(cfg)
}

<% if @auth and @store_creds -%>
function authRequired() {
  try {
    return db.serverCmdLineOpts().ok != 1;
  } catch (err) {
    if (err.message.match(/requires authentication/) || err.message.match(/not authorized on admin/)) {
      return true
    } else {
      throw("Unknown error :" + err)
    }
  }
}

if (authRequired()) {
  <%- if @replset -%>
  db.getMongo().setReadPref('primaryPreferred')
  <%- end -%>
  <%- if @admin_auth_mechanism == 'x509' -%>
  try {
    db.getSiblingDB('$external').auth(
      {
        mechanism: 'MONGODB-X509'
      }
    )
  }
  catch(err) {  
    // This isn't catching authentication errors as I'd expect...
    throw(err)
  }
  <%- else -%>
  try {
    var prev_db = db.getName()
    db = db.getSiblingDB('admin')
    db.auth('<%= @admin_username %>', '<%= @admin_password_unsensitive %>')
    db = db.getSiblingDB(prev_db)
  }
  catch (err) {
    // This isn't catching authentication errors as I'd expect...
    throw(err)
  }
  <%- end -%>
}
<% end -%>
